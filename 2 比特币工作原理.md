# 2 比特币工作原理
How Bitcoin Works

## 2.1 交易/区块/挖矿/区块链
The bitcoin system, unlike traditional banking and payment systems, is based on decentralized trust. Instead of a central trusted authority, in bitcoin, trust is achieved as an emergent property from the interactions of different participants in the bitcoin system. </br>
“比特币系统”与传统的“银行业务”和“支付系统”不同，
它是基于“去中心化的信任”（分散的信任）。
在比特币中，信任不是一个中央可信机构，而是由比特币系统中不同参与者之间的互动而产生的一种自然出现的特性。

In this chapter, we will examine bitcoin from a high level by tracking a single transaction through the bitcoin system and watch as it becomes "trusted" and accepted by the bitcoin mechanism of distributed consensus and is finally recorded on the blockchain, the distributed ledger of all transactions. Subsequent chapters will delve into the technology behind transactions, the network, and mining.</br>
在本章中，我们通过跟踪比特币系统中的一个交易，从一个高层次来考察比特币；
观察分布式共识的比特币机制如何信任和接受这个交易，并最终把它记录到区块链中，区块链是所有交易的分布式账本。
后面的章节将深入研究交易、网络和挖矿背后的技术。

### 2.1.1 比特币概述

![](https://github.com/BtcGroupCn/MasterBitcoin2ndCn/blob/master/images/mbc2_0201.png)</br>
**Figure 1. Bitcoin overview**</br>
**图1:比特币概览**

In the overview diagram shown in Bitcoin Overview, we see that the bitcoin system consists of users with wallets containing keys, transactions that are propagated across the network, and miners who produce (through competitive computation) the consensus blockchain, which is the authoritative ledger of all transactions.</br>
在图1所示的概览图中，“比特币系统”由下列组成：</br>
- 用户：有包含密钥的钱包</br>
- 交易：在网络上传播</br>
- 矿工：通过竞争计算，生成共识区块链，这是所有交易的权威账目。

Each example in this chapter is based on an actual transaction made on the bitcoin network, simulating the interactions between the users (Joe, Alice, Bob, and Gopesh) by sending funds from one wallet to another. While tracking a transaction through the bitcoin network to the blockchain, we will use a blockchain explorer site to visualize each step. A blockchain explorer is a web application that operates as a bitcoin search engine, in that it allows you to search for addresses, transactions, and blocks and see the relationships and flows between them.</br>
在本章中，每个例子都基于在比特币网络上进行的一个实际交易，
通过将资金从一个钱包发送到另一个钱包，来模拟用户（Joe、Alice、Bob和Gopesh）之间的交互。 
在一个交易通过比特币网络到达区块链时，我们将使用一个区块链接浏览器网站，查看每个步骤。 
一个区块链浏览器是一个web应用，它用作一个比特币搜索引擎，可用来搜索地址、交易和区块，查看它们之间的关系和流。

Popular blockchain explorers include:</br>
常见的区块链浏览器有：</br>
-	BlockCypher Explorer	https://live.blockcypher.com/</br>
-	blockchain.info			https://blockchain.info/</br>
-	BitPay Insight			https://insight.bitpay.com/</br>

Each of these has a search function that can take a bitcoin address, transaction hash, block number, or block hash and retrieve corresponding information from the bitcoin network. With each transaction or block example, we will provide a URL so you can look it up yourself and study it in detail.</br>
每个区块链浏览器都有一个搜索功能，能够用一个比特币地址、交易哈希、区块号或区块哈希，从比特币网络获得对应的信息。
对于每个交易或区块例子，我们会提供一个URL，这样你可以查看和研究细节。

### 2.1.2 买一杯咖啡
Alice, introduced in the previous chapter, is a new user who has just acquired her first bitcoin. In [getting_first_bitcoin], Alice met with her friend Joe to exchange some cash for bitcoin. The transaction created by Joe funded Alice’s wallet with 0.10 BTC. Now Alice will make her first retail transaction, buying a cup of coffee at Bob’s coffee shop in Palo Alto, California.</br>
Alice是一个新用户，刚获得了第一个比特币。
Alice和Joe见面时，用现金换取了比特币。由Joe创建的这个交易向Alice的钱包转了0.10 BTC。
现在，Alice将第一次使用比特币在Bob的咖啡店买一杯咖啡。

Bob’s Cafe recently started accepting bitcoin payments by adding a bitcoin option to its point-of-sale system. The prices at Bob’s Cafe are listed in the local currency (US dollars), but at the register, customers have the option of paying in either dollars or bitcoin. Alice places her order for a cup of coffee and Bob enters it into the register, as he does for all transactions. The point-of-sale system automatically converts the total price from US dollars to bitcoin at the prevailing market rate and displays the price in both currencies:</br>
Bob的咖啡店最近开始接受比特币支付，他在销售点系统中增加了一个比特币选项。
咖啡店中价格是用美元标示的，但在收银机上，顾客可以选择用美元或比特币支付。
Alice点了一杯咖啡，Bob将交易输入收银机，就像做其它交易一样。
之后，销售点系统自动按照当前市场汇率把美元转换成比特币，并显示两种货币的价格：

**Total:**</br>
$1.50 USD</br>
0.015 BTC

Bob says, "That’s one-dollar-fifty, or fifteen millibits."</br>
Bob说：总共1.50美元，或0.015比特币。

Bob’s point-of-sale system will also automatically create a special QR code containing a payment request (see Payment request QR code).</br>
Bob的销售点系统还将自动创建一个二维码，它包含一个付款请求。

Unlike a QR code that simply contains a destination bitcoin address, a payment request is a QR-encoded URL that contains a destination address, a payment amount, and a generic description such as "Bob’s Cafe." This allows a bitcoin wallet application to prefill the information used to send the payment while showing a human-readable description to the user. You can scan the QR code with a bitcoin wallet application to see what Alice would see.</br>
这个支付请求二维码并不是只包含一个目的比特币地址，它是一个二维编码的URL，包含有一个目的地址、一个支付金额、和一个描述（例如“Bob的咖啡店”）。
这样，比特币钱包应用程序在给用户显示可读描述时，可以预先填写信息，这些信息用于发送这个支付。
你可以用比特币钱包应用程序扫描这个二维码，看看Alice看到的信息。

![](https://github.com/BtcGroupCn/MasterBitcoin2ndCn/blob/master/images/mbc2_0202.png)</br>
**Figure 2. Payment request QR code**</br>
**图2:支付请求二维码**

Tip: Try to scan this with your wallet to see the address and amount but DO NOT SEND MONEY.</br>
提示：尝试用你的钱包扫描这个二维码，看看它的地址和金额，但不要支付。

The payment request QR code encodes the following URL, defined in BIP-21:</br>
根据BIP-21的定义，这个支付请求二维码编码了下面的URL：

```html
bitcoin:1GdK9UzpHBzqzX2A9JFP3Di4weBwqgmoQA?
amount=0.015&
label=Bob%27s%20Cafe&
message=Purchase%20at%20Bob%27s%20Cafe

Components of the URL

A bitcoin address: "1GdK9UzpHBzqzX2A9JFP3Di4weBwqgmoQA"
The payment amount: "0.015"
A label for the recipient address: "Bob's Cafe"
A description for the payment: "Purchase at Bob's Cafe"
```

Alice uses her smartphone to scan the barcode on display. Her smartphone shows a payment of 0.0150 BTC to Bob's Cafe and she selects Send to authorize the payment. Within a few seconds (about the same amount of time as a credit card authorization), Bob sees the transaction on the register, completing the transaction.</br>
Alice用手机扫描了这个二维码。
手机显示一个给Bob咖啡店的0.0150比特币的支付，然后她按下Send以授权支付。
在几秒内（与信用卡授权所需时间基本相同），Bob会在收银机看到这笔交易，交易完成。

In the following sections, we will examine this transaction in more detail. We’ll see how Alice’s wallet constructed it, how it was propagated across the network, how it was verified, and finally, how Bob can spend that amount in subsequent transactions.</br>
在后面的小节中，我们将更详细地研究这个交易。
我们要看看，Alice的钱包如何构建这个交易，如何在网络上传播这个交易，这个交易如何被验证，Bob如何能在以后的交易中花费这笔钱。

Note: The bitcoin network can transact in fractional values, e.g., from millibitcoin (1/1000th of a bitcoin) down to 1/100,000,000th of a bitcoin, which is known as a satoshi. Throughout this book, we’ll use the term “bitcoin” to refer to any quantity of bitcoin currency, from the smallest unit (1 satoshi) to the total number (21,000,000) of all bitcoin that will ever be mined.</br>
注意：比特币网络可以交易很小的金额，例如从1/1000比特币(1毫）到一亿分之一比特币（1聪）。
在本书中，我们将用“比特币”表示任意数量的比特币货币，从最小单位（1聪）到比特币总量 （2100,0000）。

You can examine Alice’s transaction to Bob’s Cafe on the blockchain using a block explorer site (View Alice’s transaction on blockchain.info):</br>
你可以使用区块浏览器查看Alice的这个交易。

Example 1. View Alice’s transaction on blockchain.info</br>
例1：查看Alice的交易

https://blockchain.info/tx/0627052b6f28912f2703066a912ea577f2ce4da4caa5a5fbd8a57286c345c2f2

## 2.2 比特币交易
In simple terms, a transaction tells the network that the owner of some bitcoin value has authorized the transfer of that value to another owner. The new owner can now spend the bitcoin by creating another transaction that authorizes the transfer to another owner, and so on, in a chain of ownership.</br>
简单来说，一个交易告知网络：比特币的持有者已授权把比特币转帐给其他人。
新持有者可以通过创建另一个交易把来花费比特币，将其转移给另一个人，这样就形成了一个所有权链。

### 2.2.1 交易输入和输出
Transactions are like lines in a double-entry bookkeeping ledger. Each transaction contains one or more "inputs," which are like debits against a bitcoin account. On the other side of the transaction, there are one or more "outputs," which are like credits added to a bitcoin account. The inputs and outputs (debits and credits) do not necessarily add up to the same amount. Instead, outputs add up to slightly less than inputs and the difference represents an implied transaction fee, which is a small payment collected by the miner who includes the transaction in the ledger. </br>
交易就像复式记账法中的行。
每个交易包含一个或多个“输入”，输入就像一个比特币账户的收入（debit）。
这个交易还有一个或多个“输出”，输出就像是一个比特币账户的支出（credit）。
输入总额和输出总额不必相等。当输出少于输入时，差额就是“矿工费”，矿工在将交易放入账本时可以获得这笔费用。

A bitcoin transaction is shown as a bookkeeping ledger entry in Transaction as double-entry bookkeeping.</br>
如图2-3显示的是一个比特币交易的复式账目。

![](https://github.com/BtcGroupCn/MasterBitcoin2ndCn/blob/master/images/mbc2_0203.png)</br>
**Figure 3. Transaction as double-entry bookkeeping**</br>
**图2-3交易就像复式记账**

The transaction also contains proof of ownership for each amount of bitcoin (inputs) whose value is being spent, in the form of a digital signature from the owner, which can be independently validated by anyone. In bitcoin terms, "spending" is signing a transaction that transfers value from a previous transaction over to a new owner identified by a bitcoin address.</br>
这个交易还包含了每个输入的所有权证明，用的是所有者的数字签名，可以被任何人独立验证。
在比特币术语中，“消费”是签署一个交易，它将来自前一个交易的钱转给一个新的所有者（用比特币地址标识）。

### 2.2.2 交易链
Alice’s payment to Bob’s Cafe uses a previous transaction’s output as its input. In the previous chapter, Alice received bitcoin from her friend Joe in return for cash. That transaction created a bitcoin value locked by Alice’s key. Her new transaction to Bob’s Cafe references the previous transaction as an input and creates new outputs to pay for the cup of coffee and receive change. </br>
Alice向Bob支付时，使用之前交易的一个输出作为本次交易的输入。
在前一章中，Alice从Joe那里用现金换了一些比特币。
那个交易创建了一些被Alice的密钥锁定的比特币。
Alice用之前的这个交易作为本次交易的输入，并创建新的输出来向Bob支付和获得找零。

The transactions form a chain, where the inputs from the latest transaction correspond to outputs from previous transactions. Alice’s key provides the signature that unlocks those previous transaction outputs, thereby proving to the bitcoin network that she owns the funds. She attaches the payment for coffee to Bob’s address, thereby "encumbering" that output with the requirement that Bob produces a signature in order to spend that amount. This represents a transfer of value between Alice and Bob. This chain of transactions, from Joe to Alice to Bob, is illustrated in A chain of transactions, where the output of one transaction is the input of the next transaction.</br>
这些交易形成了一条链，最近交易的输入对应以前交易的输出。
Alice的密钥提供了签名，签名解锁之前交易的输出，这就向比特币网络证明了她拥有这笔钱。
Alice将这笔钱支付给Bob的地址，从而保护了这个输出，必须有Bob的签名才能消费这笔钱。
这就是Alice和Bob之间钱的转移。下图显示了从Joe到Alice再到Bob的交易链。

![](https://github.com/BtcGroupCn/MasterBitcoin2ndCn/blob/master/images/mbc2_0204.png)</br>
**Figure 4. A chain of transactions, where the output of one transaction is the input of the next transaction**</br>
**图4：一个交易链，一个交易的输出是下一个交易的输入**

### 2.2.3 找零
Many bitcoin transactions will include outputs that reference both an address of the new owner and an address of the current owner, called the change address. This is because transaction inputs, like currency notes, cannot be divided. If you purchase a $5 US dollar item in a store but use a $20 US dollar bill to pay for the item, you expect to receive $15 US dollars in change. The same concept applies to bitcoin transaction inputs. If you purchased an item that costs 5 bitcoin but only had a 20 bitcoin input to use, you would send one output of 5 bitcoin to the store owner and one output of 15 bitcoin back to yourself as change (less any applicable transaction fee). Importantly, the change address does not have to be the same address as that of the input and for privacy reasons is often a new address from the owner’s wallet.</br>
许多比特币交易都会包含新所有者的地址（卖方地址）和当前所有者的地址（找零地址）的输出。
这是因为，交易的输入就像纸币一样，不能被分割。
如果你到商店买5美元的东西，给了商家20美元，商家会找你15美元。
这种概念也适用于比特币交易的输入。如果你要支付5比特币，但你只能使用20比特币的输入，那么，一个输出是给商家的5比特币，另一个输出是给自己的15比特币（减去交易费）。
重要的是，找零地址不必与输入地址相同，为了保护隐私，通常是所有者钱包中的一个新地址。

Different wallets may use different strategies when aggregating inputs to make a payment requested by the user. They might aggregate many small inputs, or use one that is equal to or larger than the desired payment. Unless the wallet can aggregate inputs in such a way to exactly match the desired payment plus transaction fees, the wallet will need to generate some change. This is very similar to how people handle cash. If you always use the largest bill in your pocket, you will end up with a pocket full of loose change. If you only use the loose change, you’ll always have only big bills. People subconsciously find a balance between these two extremes, and bitcoin wallet developers strive to program this balance.</br>
为了支付而汇总输入时，不同的钱包可以使用不同的策略。
它可能会聚合许多小输入，或者使用一个输入（大于等于所需付款）。
除非钱包能使输入等于输出加交易费，否则钱包需要产生一些找零。
这与人们处理现金非常相似。如果你总是用最大面额支付，你的钱包会有很多零钱。
如果你只使用零钱，你就总是只有大钞。
人们在潜意识中总是在这两个极端之间找到平衡，而比特币钱包开发者也力图实现这种平衡。

In summary, transactions move value from transaction inputs to transaction outputs. An input is a reference to a previous transaction’s output, showing where the value is coming from. A transaction output directs a specific value to a new owner’s bitcoin address and can include a change output back to the original owner. Outputs from one transaction can be used as inputs in a new transaction, thus creating a chain of ownership as the value is moved from owner to owner (see A chain of transactions, where the output of one transaction is the input of the next transaction).</br>
总之，交易是将钱从交易输入移至交易输出。
一个输入指向一个之前交易的输出，说明这个钱来自哪儿。
交易输出将指定金额发送给新所有者的比特币地址，还可以有一个找零输出。
一笔交易的输出可以被用作另一笔交易的输入，这样，随着钱从一个地址移动到另一个地址，就形成了一条所有权链。

### 2.2.4 常见的交易形式
The most common form of transaction is a simple payment from one address to another, which often includes some "change" returned to the original owner. This type of transaction has one input and two outputs and is shown in Most common transaction.</br>
最常见的交易形式是从一个地址到另一个地址的简单支付，这种交易也常常包含“找零”。
这种交易有一个输入和两个输出，如图5所示。

![](https://github.com/BtcGroupCn/MasterBitcoin2ndCn/blob/master/images/mbc2_0205.png)</br>
**Figure 5. Most common transaction**</br>
**图5：最常见的交易**

Another common form of transaction is one that aggregates several inputs into a single output (see Transaction aggregating funds). This represents the real-world equivalent of exchanging a pile of coins and currency notes for a single larger note. Transactions like these are sometimes generated by wallet applications to clean up lots of smaller amounts that were received as change for payments.</br>
另一种常见的交易形式是，汇集多个输入到一个输出（图6）。
这相当于把很多零钱兑换为一张大额钞票。
像这样的交易有时是由钱包应用程序产生，用来清理大量小额，他们是作为支付找零收取的。

![](https://github.com/BtcGroupCn/MasterBitcoin2ndCn/blob/master/images/mbc2_0206.png)</br>
**Figure 6. Transaction aggregating funds**

Finally, another transaction form that is seen often on the bitcoin ledger is a transaction that distributes one input to multiple outputs representing multiple recipients (see Transaction distributing funds). This type of transaction is sometimes used by commercial entities to distribute funds, such as when processing payroll payments to multiple employees.</br>
最后，另一种在比特币账目中常见的交易形式是，将一个输入分配给多个输出（图2-7）。
这类交易有时被商业实体用于分配资金，例如给员工发工资。

![](https://github.com/BtcGroupCn/MasterBitcoin2ndCn/blob/master/images/mbc2_0207.png)</br>
**Figure 7. Transaction distributing funds**

## 2.3 构建一个交易
Alice’s wallet application contains all the logic for selecting appropriate inputs and outputs to build a transaction to Alice’s specification. Alice only needs to specify a destination and an amount, and the rest happens in the wallet application without her seeing the details. Importantly, a wallet application can construct transactions even if it is completely offline. Like writing a check at home and later sending it to the bank in an envelope, the transaction does not need to be constructed and signed while connected to the bitcoin network.</br>
Alice的钱包应用程序包含所有的逻辑：按照Alice的要求，选择合适的输入和输出，来构建一个交易。
Alice只需要指定一个目标地址和一个金额，其余的事情由钱包应用程序完成，不需要她关心细节。
重要的是，即使钱包应用程序不在线，它也能构建交易。
就像在家写了一张支票，然后放到信封里发给银行一样，不用连接到比特币网络，也能构建和签名交易。

### 2.3.1 获取正确的输入
Alice’s wallet application will first have to find inputs that can pay the amount she wants to send to Bob. Most wallets keep track of all the available outputs belonging to addresses in the wallet. Therefore, Alice’s wallet would contain a copy of the transaction output from Joe’s transaction, which was created in exchange for cash (see [getting_first_bitcoin]). </br>
Alice的钱包应用程序首先要找到能够支付的输入。
大多数钱包应用程序跟踪着钱包中这些地址的所有可用输出。
因此，Alice的钱包包含她购买比特币交易的交易输出。

A bitcoin wallet application that runs as a full-node client actually contains a copy of every unspent output from every transaction in the blockchain. This allows a wallet to construct transaction inputs as well as quickly verify incoming transactions as having correct inputs. However, because a full-node client takes up a lot of disk space, most user wallets run "lightweight" clients that track only the user’s own unspent outputs.</br>
当比特币钱包应用程序作为一个全节点客户端运行时，它实际包含了区块链中每个交易的未花费输出。
这使得钱包能够构建交易输入，又能快速验证收到的交易有争取的输入。
但是，全节点客户端占用硬盘空间太大，所以，多数用户钱包运行轻量级客户端，它只跟踪用户自己的未花费输出。

If the wallet application does not maintain a copy of unspent transaction outputs, it can query the bitcoin network to retrieve this information using a variety of APIs available by different providers or by asking a full-node using an application programming interface (API) call. Look up all the unspent outputs for Alice’s bitcoin address shows an API request, constructed as an HTTP GET command to a specific URL. This URL will return all the unspent transaction outputs for an address, giving any application the information it needs to construct transaction inputs for spending. We use the simple command-line HTTP client cURL to retrieve the response.</br>
如果钱包应用程序没有未花费交易输出，它可以通过查询比特币网络来获得这个信息，方法是使用不同提供商的各种API，或者使用API向全节点询问。
例2-1显示了一个API请求，它被构造为到一个特定URL的一个HTTP GET命令。
这个URL会返回某个地址的所有未花费交易输出，为应用程序提供构造交易输入所需的信息。
我们使用一个简单的命令行HTTP客户端 cURL来获得这个响应。

Example 2. Look up all the unspent outputs for Alice’s bitcoin address</br>
例2: 查找Alice的比特币地址所有的未花费输出

```html
$ curl https://blockchain.info/unspent?active=1Cdid9KFAaatwczBwBttQcwXYCpvK8h7FK
{
  "unspent_outputs":[
  {
	  "tx_hash"    	: "186f9f998a5...2836dd734d2804fe65fa35779",
	  "tx_index"   	: 104810202,
	  "tx_output_n"	: 0,					
	  "script"      	: "76a9147f9b1a7fb68d60c536c2fd8aeaa53a8f3cc025a888ac",
	  "value"       	: 10000000,
	  "value_hex"  	: "00989680",
	  "confirmations"	: 0
  }
  ]
}
```



